# # 1. SERVER DEPLOYMENT & SERVICE
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: server
#   namespace: "2401205"
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: server
#   template:
#     metadata:
#       labels:
#         app: server
#     spec:
#       containers:
#       - name: server
#         image: 127.0.0.1:30085/2401205_learniva/text-emotion-detection:latest
#         imagePullPolicy: Always
#         ports:
#         - containerPort: 3000
#         env:
#         - name: PORT
#           value: "3000"
        
#         # ‚úÖ UPDATED: Reads HOST and PORT from your secrets now
#         - name: DB_HOST
#           valueFrom:
#             secretKeyRef:
#               name: learniva-secrets
#               key: DB_HOST
#         - name: DB_PORT
#           valueFrom:
#             secretKeyRef:
#               name: learniva-secrets
#               key: DB_PORT
        
#         # Database Credentials
#         - name: DB_USER
#           valueFrom:
#             secretKeyRef:
#               name: learniva-secrets
#               key: mysql-user
#         - name: DB_PASSWORD
#           valueFrom:
#             secretKeyRef:
#               name: learniva-secrets
#               key: mysql-password
#         - name: DB_NAME
#           valueFrom:
#             secretKeyRef:
#               name: learniva-secrets
#               key: mysql-database
#         - name: OPENROUTER_API_KEY
#           valueFrom:
#             secretKeyRef:
#               name: learniva-secrets
#               key: openrouter-api-key
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: server-service
#   namespace: "2401205"
# spec:
#   selector:
#     app: server
#   ports:
#   - port: 3000
#     targetPort: 3000
#   type: LoadBalancer


# ---


# # 2. CLIENT DEPLOYMENT & SERVICE
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: client
#   namespace: "2401205"
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: client
#   template:
#     metadata:
#       labels:
#         app: client
#     spec:
#       containers:
#       - name: client
#         image: 127.0.0.1:30085/2401205_learniva/learniva-client:latest
#         imagePullPolicy: Always
#         ports:
#         - containerPort: 80
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: client-service
#   namespace: "2401205"
# spec:
#   selector:
#     app: client
#   ports:
#   - port: 5173
#     targetPort: 80
#   type: LoadBalancer

# ---

# # 3. INGRESS
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: learniva-ingress
#   namespace: "2401205"
# spec:
#   ingressClassName: nginx
#   rules:
#     - host: learniva.imcc.com
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: client-service
#                 port:
#                   number: 5173





# ===========================
# 1. SERVER (BACKEND) DEPLOYMENT & SERVICE
# ===========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: server
  namespace: "2401205"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: server
  template:
    metadata:
      labels:
        app: server
    spec:
      # --- INIT CONTAINER: The "Auto-Setup" Task ---
      initContainers:
        - name: init-db
          image: mysql:8.0
          env:
            # ‚¨áÔ∏è Pulling credentials from your SECRETS file ‚¨áÔ∏è
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: learniva-secrets
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: learniva-secrets
                  key: DB_PORT
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: learniva-secrets
                  key: mysql-user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: learniva-secrets
                  key: mysql-password
          command:
            - "bash"
            - "-c"
            - |
              echo "‚è≥ Waiting for MySQL connection at $DB_HOST..."
              # 1. Wait loop: Tries to connect every 5 seconds until successful
              until mysql -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD -e "select 1"; do
                echo "Database not ready... sleeping 5s"
                sleep 5
              done
              
              echo "‚úÖ MySQL is up! Creating Learniva Tables..."
              
              # 2. SQL Execution: Creates your specific tables
              mysql -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD <<EOF
              CREATE DATABASE IF NOT EXISTS learniva_db;
              USE learniva_db;

              CREATE TABLE IF NOT EXISTS users (
                  id INT AUTO_INCREMENT PRIMARY KEY,
                  username VARCHAR(255) NOT NULL UNIQUE,
                  email VARCHAR(255),
                  password_hash VARCHAR(255) NOT NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
              );

              CREATE TABLE IF NOT EXISTS courses (
                  id INT AUTO_INCREMENT PRIMARY KEY,
                  user_id INT NOT NULL,
                  topic VARCHAR(255) NOT NULL,
                  duration INT,
                  skill_level VARCHAR(50),
                  learning_goals TEXT,
                  generated_content JSON,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
              );

              CREATE TABLE IF NOT EXISTS user_course_progress (
                  id INT AUTO_INCREMENT PRIMARY KEY,
                  user_id INT NOT NULL,
                  course_id INT NOT NULL,
                  completed_resources JSON,
                  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                  UNIQUE KEY unique_progress (user_id, course_id),
                  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
              );

              CREATE TABLE IF NOT EXISTS userquizresults (
                  id INT AUTO_INCREMENT PRIMARY KEY,
                  user_id INT NOT NULL,
                  course_id INT NOT NULL,
                  topic VARCHAR(255),
                  score INT,
                  total_questions INT,
                  difficulty VARCHAR(50),
                  quiz_type VARCHAR(50),
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
              );
              EOF
              echo "üöÄ Learniva Database initialized successfully!"

      # --- MAIN CONTAINER: The Node.js Server ---
      containers:
      - name: server
        image: 127.0.0.1:30085/2401205_learniva/text-emotion-detection:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: learniva-secrets
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              name: learniva-secrets
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: learniva-secrets
              key: mysql-user
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: learniva-secrets
              key: mysql-password
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: learniva-secrets
              key: mysql-database
        - name: OPENROUTER_API_KEY
          valueFrom:
            secretKeyRef:
              name: learniva-secrets
              key: openrouter-api-key

---
apiVersion: v1
kind: Service
metadata:
  name: server-service
  namespace: "2401205"
spec:
  selector:
    app: server
  ports:
  - port: 3000
    targetPort: 3000
  type: ClusterIP

---

# ===========================
# 2. CLIENT (FRONTEND) DEPLOYMENT & SERVICE
# ===========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client
  namespace: "2401205"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: client
  template:
    metadata:
      labels:
        app: client
    spec:
      containers:
      - name: client
        image: 127.0.0.1:30085/2401205_learniva/learniva-client:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: client-service
  namespace: "2401205"
spec:
  selector:
    app: client
  ports:
  - port: 5173
    targetPort: 80
  type: LoadBalancer

---

# ===========================
# 3. INGRESS
# ===========================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: learniva-ingress
  namespace: "2401205"
spec:
  ingressClassName: nginx
  rules:
    - host: learniva.imcc.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: client-service
                port:
                  number: 5173